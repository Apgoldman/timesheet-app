<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Timesheet App — UI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { font-family: system-ui, Arial, sans-serif; color: #111; }
    body { max-width: 56rem; margin: 2rem auto; padding: 1rem; }
    h1 { margin-top: 0; }
    textarea { width:100%; height: 200px; font-family: monospace; font-size: 13px; }
    .row { display:flex; gap: .5rem; align-items:center; margin-bottom: .75rem; flex-wrap:wrap; }
    .col { flex:1 1 auto; min-width:180px; }
    button { padding: .5rem .8rem; font-size: 14px; cursor:pointer; }
    .muted { color: #666; font-size: 0.95rem; }
    .result { background:#fafafa; border:1px solid #eee; padding: .75rem; border-radius:6px; margin-top:.5rem; }
    table { width:100%; border-collapse: collapse; margin-top: .5rem; }
    th,td { border:1px solid #eee; padding: .4rem .5rem; text-align:left; font-size:13px; }
    label { font-weight:600; font-size:13px; }
    .small { font-size: 13px; }
    .download { margin-top: .5rem; display:block; }
    input[type="file"] { padding: .25rem; }
  </style>
</head>
<body>
  <h1>Timesheet App — Simple UI</h1>
  <p class="muted">Use this page to call the deployed API endpoints for preview, export, and to upload logs/files.</p>

  <section>
    <h2>Preview payload (JSON)</h2>
    <div class="row">
      <div class="col">
        <label for="payload">Payload JSON</label>
        <textarea id="payload" placeholder='Paste preview payload JSON here'></textarea>
      </div>
    </div>
    <div class="row">
      <button id="load-sample">Load sample preview_payload.json</button>
      <button id="do-preview">POST /api/preview</button>
      <div class="muted small">Note: payload should have "entries": [ ... ]</div>
    </div>

    <div id="preview-result" class="result" style="display:none;">
      <div><strong>Preview result</strong></div>
      <div id="preview-draft" style="margin-top:.5rem;"></div>
      <div id="preview-entries"></div>
    </div>
  </section>

  <hr/>

  <section>
    <h2>Export</h2>
    <div class="row">
      <div class="col">
        <label for="worker">Worker (name)</label>
        <input id="worker" class="small" placeholder="e.g. Chris" />
      </div>
      <div>
        <label for="week">Week start (ISO date)</label>
        <input id="week" class="small" placeholder="YYYY-MM-DD" />
      </div>
      <div>
        <button id="do-export">POST /api/export</button>
      </div>
    </div>

    <div id="export-result" class="result" style="display:none;">
      <div><strong>Export result</strong></div>
      <div id="export-info" style="margin-top:.5rem;"></div>
      <a id="export-download" class="download" href="#" download style="display:none;">Download file</a>
    </div>
  </section>

  <hr/>

  <section>
    <h2>Upload a log or file</h2>
    <div class="row">
      <input type="file" id="upload-file" />
      <button id="upload-btn">Upload</button>
    </div>
    <div id="upload-result" class="result" style="display:none;">
      <div><strong>Upload result</strong></div>
      <div id="upload-info" style="margin-top:.5rem;"></div>
      <a id="upload-download" class="download" href="#" download style="display:none;">Download file</a>
    </div>
  </section>

  <hr/>

  <section>
    <h2>Diagnostics</h2>
    <div class="muted small">Requests are made to the same origin. If the API is unreachable from this page you will see errors below.</div>
    <pre id="log" style="background:#111;color:#fff;padding:.75rem;border-radius:6px;max-height:240px;overflow:auto;"></pre>
  </section>

  <script>
    const payloadEl = document.getElementById('payload');
    const loadSampleBtn = document.getElementById('load-sample');
    const doPreviewBtn = document.getElementById('do-preview');
    const previewResult = document.getElementById('preview-result');
    const previewDraft = document.getElementById('preview-draft');
    const previewEntries = document.getElementById('preview-entries');

    const workerEl = document.getElementById('worker');
    const weekEl = document.getElementById('week');
    const doExportBtn = document.getElementById('do-export');
    const exportResult = document.getElementById('export-result');
    const exportInfo = document.getElementById('export-info');
    const exportDownload = document.getElementById('export-download');

    const uploadFileInput = document.getElementById('upload-file');
    const uploadBtn = document.getElementById('upload-btn');
    const uploadResult = document.getElementById('upload-result');
    const uploadInfo = document.getElementById('upload-info');
    const uploadDownload = document.getElementById('upload-download');

    const logEl = document.getElementById('log');
    function log(...args){ logEl.textContent += args.map(a=> (typeof a === 'object' ? JSON.stringify(a,null,2) : String(a))).join(' ') + '\\n'; logEl.scrollTop = logEl.scrollHeight; }

    // Try to fetch preview_payload.json from server if present
    loadSampleBtn.addEventListener('click', async () => {
      try {
        log('Fetching preview_payload.json ...');
        const r = await fetch('/preview_payload.json');
        if (!r.ok) throw new Error('Not found: /preview_payload.json');
        const txt = await r.text();
        payloadEl.value = txt;
        log('Loaded preview_payload.json');
      } catch (err) {
        log('Could not load preview_payload.json:', err.message);
        // fallback sample
        payloadEl.value = JSON.stringify({
          entries: [
            { worker: "Chris", date: "2025-12-29", address: "123 Main St", unit: "", start: "08:00", end: "12:00", totalHours: 4, materials: "", notes: "" },
            { worker: "Chris", date: "2025-12-29", address: "456 Oak Ave", unit: "", start: "13:00", end: "17:00", totalHours: 4, materials: "", notes: "" }
          ]
        }, null, 2);
        log('Inserted fallback sample payload.');
      }
    });

    doPreviewBtn.addEventListener('click', async () => {
      previewResult.style.display = 'none';
      previewDraft.textContent = '';
      previewEntries.innerHTML = '';
      try {
        const body = JSON.parse(payloadEl.value);
        log('POST /api/preview', body);
        const r = await fetch('/api/preview', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        const data = await r.json();
        if (!r.ok) {
          log('Preview failed:', data);
          previewDraft.textContent = 'Error: ' + (data.message || JSON.stringify(data));
          previewResult.style.display = '';
          return;
        }
        log('Preview response:', data);
        previewResult.style.display = '';
        previewDraft.innerHTML = '<div><strong>draftId:</strong> ' + data.draftId + '</div>';
        if (data.entries) {
          renderEntries(data.entries);
        } else if (data.results) {
          renderEntries(data.results);
        }
      } catch (err) {
        log('Preview error:', err.message);
        previewResult.style.display = '';
        previewDraft.textContent = 'Error: ' + err.message;
      }
    });

    function renderEntries(entries) {
      if (!entries || !entries.length) { previewEntries.innerHTML = '<div class="muted">No entries returned.</div>'; return; }
      let html = '<table><thead><tr><th>Worker</th><th>Date</th><th>Address</th><th>Start</th><th>End</th><th>Hours</th></tr></thead><tbody>';
      for (const e of entries) {
        const worker = e.worker || e.image?.originalname || '';
        const date = e.date || '';
        const address = e.address || (e.parsed && e.parsed.address) || '';
        const start = e.start || '';
        const end = e.end || '';
        const hours = e.totalHours || e.hours || '';
        html += `<tr><td>${escapeHtml(worker)}</td><td>${escapeHtml(date)}</td><td>${escapeHtml(address)}</td><td>${escapeHtml(start)}</td><td>${escapeHtml(end)}</td><td>${escapeHtml(hours)}</td></tr>`;
      }
      html += '</tbody></table>';
      previewEntries.innerHTML = html;
    }

    doExportBtn.addEventListener('click', async () => {
      exportResult.style.display = 'none';
      exportInfo.textContent = '';
      exportDownload.style.display = 'none';
      try {
        let draftId = null;
        const text = previewDraft.textContent || '';
        const m = text.match(/draftId['"]?:?\s*([0-9]+)/) || text.match(/draftId:\s*([0-9]+)/);
        if (m) draftId = m[1];

        if (!draftId) {
          draftId = prompt('No draftId found from preview. Please enter draftId (or cancel):');
          if (!draftId) {
            log('Export aborted: no draftId');
            return;
          }
        }

        const worker = workerEl.value || 'Chris';
        const weekStartISO = weekEl.value || new Date().toISOString().slice(0,10);

        const body = { draftId, worker, weekStartISO };
        log('POST /api/export', body);
        const r = await fetch('/api/export', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        const data = await r.json();
        if (!r.ok) {
          log('Export failed:', data);
          exportInfo.textContent = 'Error: ' + (data.message || JSON.stringify(data));
          exportResult.style.display = '';
          return;
        }
        log('Export response:', data);
        exportResult.style.display = '';
        exportInfo.textContent = JSON.stringify(data, null, 2);

        if (data.downloadUrl) {
          const dlUrl = data.downloadUrl.startsWith('http') ? data.downloadUrl : (location.origin + data.downloadUrl);
          exportDownload.href = dlUrl;
          exportDownload.textContent = 'Download: ' + (data.filename || dlUrl.split('/').pop());
          exportDownload.style.display = 'inline-block';
        }
      } catch (err) {
        log('Export error:', err.message);
        exportResult.style.display = '';
        exportInfo.textContent = 'Error: ' + err.message;
      }
    });

    uploadBtn.addEventListener('click', async () => {
      uploadResult.style.display = 'none';
      uploadInfo.textContent = '';
      uploadDownload.style.display = 'none';
      const f = uploadFileInput.files && uploadFileInput.files[0];
      if (!f) { alert('Choose a file first'); return; }
      try {
        const fd = new FormData();
        fd.append('file', f);
        log('Uploading', f.name);
        const r = await fetch('/api/upload/csv', { method: 'POST', body: fd });
        const data = await r.json();
        if (!r.ok) {
          log('Upload failed', data);
          uploadInfo.textContent = 'Error: ' + (data.message || JSON.stringify(data));
          uploadResult.style.display = '';
          return;
        }
        log('Upload response', data);
        uploadResult.style.display = '';
        uploadInfo.textContent = JSON.stringify(data, null, 2);
        // prefer explicit url returned by server, otherwise construct from path
        if (data.url) {
          const dl = data.url.startsWith('http') ? data.url : (location.origin + data.url);
          uploadDownload.href = dl;
          uploadDownload.textContent = 'Download: ' + (data.filename || dl.split('/').pop());
          uploadDownload.style.display = 'inline-block';
        } else if (data.path) {
          const filename = data.path.split('/').pop();
          const dl = location.origin + '/uploads/' + filename;
          uploadDownload.href = dl;
          uploadDownload.textContent = 'Download: ' + filename;
          uploadDownload.style.display = 'inline-block';
        }
      } catch (err) {
        log('Upload error', err.message);
        uploadResult.style.display = '';
        uploadInfo.textContent = 'Error: ' + err.message;
      }
    });

    function escapeHtml(s) {
      if (s == null) return '';
      return String(s).replace(/[&<>"']/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[m]));
    }

    // init: load a fallback sample so the page isn't empty
    payloadEl.value = JSON.stringify({
      entries: [
        { worker: "Chris", date: new Date().toISOString().slice(0,10), address: "123 Main St", unit: "", start: "08:00", end: "12:00", totalHours: 4, materials: "", notes: "" }
      ]
    }, null, 2);
  </script>
</body>
</html>
