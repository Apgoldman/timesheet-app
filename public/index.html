<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Timesheet App — UI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { font-family: system-ui, Arial, sans-serif; color: #111; }
    body { max-width: 56rem; margin: 2rem auto; padding: 1rem; }
    h1 { margin-top: 0; }
    textarea { width:100%; height: 200px; font-family: monospace; font-size: 13px; }
    .row { display:flex; gap: .5rem; align-items:center; margin-bottom: .75rem; flex-wrap:wrap; }
    .col { flex:1 1 auto; min-width:180px; }
    button { padding: .5rem .8rem; font-size: 14px; cursor:pointer; }
    .muted { color: #666; font-size: 0.95rem; }
    .result { background:#fafafa; border:1px solid #eee; padding: .75rem; border-radius:6px; margin-top:.5rem; }
    table { width:100%; border-collapse: collapse; margin-top: .5rem; }
    th,td { border:1px solid #eee; padding: .4rem .5rem; text-align:left; font-size:13px; }
    label { font-weight:600; font-size:13px; }
    .small { font-size: 13px; }
    .download { margin-top: .5rem; display:block; }
    input[type="file"] { padding: .25rem; }
    .flex { display:flex; gap:.5rem; align-items:center; }
  </style>
</head>
<body>
  <h1>Timesheet App — Simple UI</h1>
  <p class="muted">Upload an image (JPG/PNG) or paste text to parse logs into timesheet rows, preview, then export per-worker Excel files.</p>

  <section>
    <h2>Parse: Upload image (OCR)</h2>
    <div class="row">
      <input type="file" id="ocr-file" accept="image/*" />
      <button id="parse-ocr-btn">Parse Image (OCR)</button>
    </div>
    <div id="ocr-result" class="result" style="display:none;">
      <div><strong>OCR parse result</strong></div>
      <pre id="ocr-preview" style="white-space:pre-wrap;margin-top:.5rem;"></pre>
      <a id="ocr-download" class="download" href="#" style="display:none;">Preview download</a>
    </div>
  </section>

  <hr/>

  <section>
    <h2>Parse: Paste text</h2>
    <div class="row">
      <div class="col">
        <label for="text-input">Paste log text here</label>
        <textarea id="text-input" placeholder="Paste your text logs here"></textarea>
      </div>
    </div>
    <div class="row">
      <button id="parse-text-btn">Parse Text</button>
    </div>
  </section>

  <hr/>

  <section>
    <h2>Preview payload (JSON)</h2>
    <div class="row">
      <div class="col">
        <label for="payload">Payload JSON</label>
        <textarea id="payload" placeholder='Paste preview payload JSON here'></textarea>
      </div>
    </div>
    <div class="row">
      <button id="load-sample">Load sample preview_payload.json</button>
      <button id="do-preview">POST /api/preview</button>
      <div class="muted small">Note: payload should have "entries": [ ... ]</div>
    </div>

    <div id="preview-result" class="result" style="display:none;">
      <div><strong>Preview result</strong></div>
      <div id="preview-draft" style="margin-top:.5rem;"></div>
      <div id="preview-entries"></div>
    </div>
  </section>

  <hr/>

  <section>
    <h2>Export</h2>
    <div class="row">
      <div class="col">
        <label for="worker">Worker (name)</label>
        <input id="worker" class="small" placeholder="e.g. Chris" />
      </div>
      <div>
        <label for="week">Week start (ISO date)</label>
        <input id="week" class="small" placeholder="YYYY-MM-DD" />
      </div>
      <div>
        <button id="do-export">POST /api/export</button>
      </div>
    </div>

    <div id="export-result" class="result" style="display:none;">
      <div><strong>Export result</strong></div>
      <div id="export-info" style="margin-top:.5rem;"></div>
      <a id="export-download" class="download" href="#" download style="display:none;">Download file</a>
    </div>
  </section>

  <hr/>

  <section>
    <h2>Diagnostics</h2>
    <div class="muted small">Requests are made to the same origin. If the API is unreachable from this page you will see errors below.</div>
    <pre id="log" style="background:#111;color:#fff;padding:.75rem;border-radius:6px;max-height:240px;overflow:auto;"></pre>
  </section>

  <script>
    const ocrFile = document.getElementById('ocr-file');
    const parseOcrBtn = document.getElementById('parse-ocr-btn');
    const ocrResult = document.getElementById('ocr-result');
    const ocrPreview = document.getElementById('ocr-preview');
    const ocrDownload = document.getElementById('ocr-download');

    const textInput = document.getElementById('text-input');
    const parseTextBtn = document.getElementById('parse-text-btn');

    const payloadEl = document.getElementById('payload');
    const loadSampleBtn = document.getElementById('load-sample');
    const doPreviewBtn = document.getElementById('do-preview');
    const previewResult = document.getElementById('preview-result');
    const previewDraft = document.getElementById('preview-draft');
    const previewEntries = document.getElementById('preview-entries');

    const workerEl = document.getElementById('worker');
    const weekEl = document.getElementById('week');
    const doExportBtn = document.getElementById('do-export');
    const exportResult = document.getElementById('export-result');
    const exportInfo = document.getElementById('export-info');
    const exportDownload = document.getElementById('export-download');

    const logEl = document.getElementById('log');
    function log(...args){ logEl.textContent += args.map(a=> (typeof a === 'object' ? JSON.stringify(a,null,2) : String(a))).join(' ') + '\\n'; logEl.scrollTop = logEl.scrollHeight; }

    parseOcrBtn.addEventListener('click', async () => {
      ocrResult.style.display = 'none';
      ocrPreview.textContent = '';
      ocrDownload.style.display = 'none';
      const f = ocrFile.files && ocrFile.files[0];
      if (!f) { alert('Choose an image first'); return; }
      try {
        const fd = new FormData();
        fd.append('file', f);
        log('Uploading image for OCR:', f.name);
        const r = await fetch('/api/parse/ocr', { method: 'POST', body: fd });
        const data = await r.json();
        if (!r.ok) {
          log('OCR parse failed', data);
          alert('OCR failed: ' + (data.message || JSON.stringify(data)));
          return;
        }
        log('OCR parse response', data);
        ocrResult.style.display = '';
        ocrPreview.textContent = data.previewText || JSON.stringify(data.entries, null, 2);
        // Show preview entries
        previewDraft.textContent = 'draftId: ' + data.draftId;
        renderEntries(data.entries || []);
      } catch (err) {
        log('OCR error', err.message);
        alert('OCR error: ' + err.message);
      }
    });

    parseTextBtn.addEventListener('click', async () => {
      const txt = textInput.value;
      if (!txt) { alert('Paste text in the textarea first'); return; }
      try {
        log('Parsing pasted text');
        const r = await fetch('/api/parse/text', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ text: txt }) });
        const data = await r.json();
        if (!r.ok) {
          log('Text parse failed', data);
          alert('Parse failed: ' + (data.message || JSON.stringify(data)));
          return;
        }
        log('Text parse response', data);
        previewDraft.textContent = 'draftId: ' + data.draftId;
        renderEntries(data.entries || []);
      } catch (err) {
        log('Parse error', err.message);
        alert('Parse error: ' + err.message);
      }
    });

    loadSampleBtn.addEventListener('click', async () => {
      try {
        log('Fetching preview_payload.json ...');
        const r = await fetch('/preview_payload.json');
        if (!r.ok) throw new Error('Not found: /preview_payload.json');
        const txt = await r.text();
        payloadEl.value = txt;
        log('Loaded preview_payload.json');
      } catch (err) {
        log('Could not load preview_payload.json:', err.message);
        payloadEl.value = JSON.stringify({
          entries: [
            { worker: "Chris", date: new Date().toISOString().slice(0,10), address: "123 Main St", unit: "", start: "08:00", end: "12:00", totalHours: 4, materials: "", notes: "" }
          ]
        }, null, 2);
        log('Inserted fallback sample payload.');
      }
    });

    doPreviewBtn.addEventListener('click', async () => {
      previewResult.style.display = 'none';
      previewDraft.textContent = '';
      previewEntries.innerHTML = '';
      try {
        const body = JSON.parse(payloadEl.value);
        log('POST /api/preview', body);
        const r = await fetch('/api/preview', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        const data = await r.json();
        if (!r.ok) {
          log('Preview failed:', data);
          previewDraft.textContent = 'Error: ' + (data.message || JSON.stringify(data));
          previewResult.style.display = '';
          return;
        }
        log('Preview response:', data);
        previewResult.style.display = '';
        previewDraft.innerHTML = '<div><strong>draftId:</strong> ' + data.draftId + '</div>';
        if (data.entries) renderEntries(data.entries);
      } catch (err) {
        log('Preview error:', err.message);
        previewResult.style.display = '';
        previewDraft.textContent = 'Error: ' + err.message;
      }
    });

    doExportBtn.addEventListener('click', async () => {
      exportResult.style.display = 'none';
      exportInfo.textContent = '';
      exportDownload.style.display = 'none';
      try {
        const draftText = previewDraft.textContent || '';
        const m = draftText.match(/draftId[:]?\s*([0-9]+)/);
        if (!m) { alert('No draftId found. Run a Preview/Parse first.'); return; }
        const draftId = m[1];
        const worker = workerEl.value || '';
        const weekStartISO = weekEl.value || '';
        const body = { draftId, worker };
        if (weekStartISO) body.weekStartISO = weekStartISO;
        log('POST /api/export', body);
        const r = await fetch('/api/export', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
        const data = await r.json();
        if (!r.ok) {
          log('Export failed', data);
          exportInfo.textContent = 'Error: ' + (data.message || JSON.stringify(data));
          exportResult.style.display = '';
          return;
        }
        log('Export response', data);
        exportResult.style.display = '';
        exportInfo.textContent = JSON.stringify(data, null, 2);
        if (data.downloadUrl) {
          const dl = data.downloadUrl.startsWith('http') ? data.downloadUrl : (location.origin + data.downloadUrl);
          exportDownload.href = dl;
          exportDownload.textContent = 'Download: ' + (data.filename || dl.split('/').pop()) + ' (' + (data.rowCount||0) + ' rows, ' + (data.fileSize? (Math.round(data.fileSize/1024) + " KB") : "unknown size") + ')';
          exportDownload.style.display = 'inline-block';
        }
      } catch (err) {
        log('Export error', err.message);
        exportResult.style.display = '';
        exportInfo.textContent = 'Error: ' + err.message;
      }
    });

    function renderEntries(entries) {
      previewResult.style.display = '';
      if (!entries || !entries.length) { previewEntries.innerHTML = '<div class="muted">No entries returned.</div>'; return; }
      let html = '<table><thead><tr><th>Worker</th><th>Date</th><th>Address</th><th>Start</th><th>End</th><th>Hours</th></tr></thead><tbody>';
      for (const e of entries) {
        const worker = e.worker || '';
        const date = e.date || '';
        const address = e.address || '';
        const start = e.start || '';
        const end = e.end || '';
        const hours = e.totalHours || e.hours || '';
        html += `<tr><td>${escapeHtml(worker)}</td><td>${escapeHtml(date)}</td><td>${escapeHtml(address)}</td><td>${escapeHtml(start)}</td><td>${escapeHtml(end)}</td><td>${escapeHtml(hours)}</td></tr>`;
      }
      html += '</tbody></table>';
      previewEntries.innerHTML = html;
    }

    function escapeHtml(s) {
      if (s == null) return '';
      return String(s).replace(/[&<>"']/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[m]));
    }

    // init: load a fallback sample so the page isn't empty
    payloadEl.value = JSON.stringify({
      entries: [
        { worker: "Chris", date: new Date().toISOString().slice(0,10), address: "123 Main St", unit: "", start: "08:00", end: "12:00", totalHours: 4, materials: "", notes: "" }
      ]
    }, null, 2);
  </script>
</body>
</html>
